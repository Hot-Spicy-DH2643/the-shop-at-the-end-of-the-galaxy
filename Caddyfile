# Caddyfile - Production Configuration with Cloudflare Flexible SSL

# Cloudflare handles HTTPS, Caddy serves HTTP only (no certificate needed)

galaxyend.com { # Frontend - serve the main site over HTTPS
    tls internal # Self-signed cert satisfies Cloudflare Full (not strict)
    reverse_proxy frontend:3000 { # Forward Cloudflare headers
        header_up X-Real-IP {http.request.header.Cf-Connecting-Ip}
    }

    # Backend API - strip /api prefix and forward to backend
    # Example: /api/auth/login -> backend receives /auth/login
    handle /api/* {
        uri strip_prefix /api
        reverse_proxy backend:3001 {
            header_up X-Real-IP {http.request.header.Cf-Connecting-Ip}
            header_up X-Forwarded-Proto {http.request.header.X-Forwarded-Proto}
        }
    }

    # GraphQL endpoint - forward directly
    # Example: /graphql -> backend receives /graphql
    handle /graphql* {
        reverse_proxy backend:3001 {
            header_up X-Real-IP {http.request.header.Cf-Connecting-Ip}
            header_up X-Forwarded-Proto {http.request.header.X-Forwarded-Proto}
        }
    }

    # WebSocket endpoint - forward directly to backend
    # Example: /ws/* -> backend receives /ws/*
    handle /ws/* {
        reverse_proxy backend:3001 {
            header_up X-Real-IP {http.request.header.Cf-Connecting-Ip}
            header_up X-Forwarded-Proto {http.request.header.X-Forwarded-Proto}
            # Enable WebSocket support
            header_up Upgrade {http.request.header.Upgrade}
            header_up Connection {http.request.header.Connection}
        }
    }

    # Logging
    log {
        output file /var/log/caddy/access.log
    }

}

http://galaxyend.com {
    redir https://galaxyend.com{uri} permanent
}

# Local development configuration (uncomment to use)

# :80 {

# reverse_proxy frontend:3000

#

# handle /api/\* {

# uri strip_prefix /api

# reverse_proxy backend:3001

# }

#

# handle /graphql\* {

# reverse_proxy backend:3001

# }

# }

# Alternative: If you want to serve on port 8080

# :8080 {

# reverse_proxy frontend:3000

#

# handle /api\* {

# reverse_proxy backend:3001

# }

#

# handle /graphql\* {

# reverse_proxy backend:3001

# }

# }
